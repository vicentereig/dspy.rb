# DSPy.rb 0.31.0 – TOON everywhere

## Highlights

- **Token-Oriented Object Notation (TOON)** lands for every Enhanced Prompting flow. Flip `schema_format: :baml` and `data_format: :toon` to cut schema + payload tokens without rewriting signatures or prompts.
- **ReAct + tools speak TOON**. Iteration history, available tools, and observation payloads render as TOON tables so loops stay readable and cheap.
- **Benchmark + docs refresh**. `examples/baml_vs_json_benchmark.rb` now compares every schema/data combination and ships `.json/.csv/.txt` artifacts for decks. A new article (`docs/src/_articles/toon-data-format.md`) spells out savings, FAQs, and the Sorbet::Toon roadmap.
- **CI + dependency hygiene**. Sorbet::Toon specs run in GitHub Actions with the same feature toggles as the DSPy core job, and `DSPy::Evals#to_polars` now lazy-loads Polars so lightweight bundles stop erroring.

## Upgrade checklist

1. **Update gems** – `bundle update dspy dspy-openai dspy-anthropic dspy-gemini sorbet-toon` (install only the adapters you need). The new provider gems live in their own READMEs:
   - [OpenAI/OpenRouter/Ollama](https://github.com/vicentereig/dspy.rb/blob/main/lib/dspy/openai/README.md)
   - [Anthropic](https://github.com/vicentereig/dspy.rb/blob/main/lib/dspy/anthropic/README.md)
   - [Gemini](https://github.com/vicentereig/dspy.rb/blob/main/lib/dspy/gemini/README.md)
   - [Sorbet::Toon codec](https://github.com/vicentereig/dspy.rb/blob/main/lib/sorbet/toon/README.md)
2. **Flip Enhanced Prompting defaults** – set `schema_format: :baml` and `data_format: :toon` globally or per-LM:

   ```ruby
   DSPy.configure do |config|
     config.lm = DSPy::LM.new(
       'openai/gpt-4o-mini',
       api_key: ENV.fetch('OPENAI_API_KEY'),
       schema_format: :baml,
       data_format: :toon
     )
   end
   ```

3. **ReAct/tooling** – If you extend `DSPy::ReAct`, make sure history/tool rendering uses the built-in helpers (now TOON-aware) instead of hand-built JSON.
4. **Benchmarks (optional)** – Point stakeholders to `examples/baml_vs_json_benchmark.rb` for reproducible token savings across schema/data combinations.

## Example snippets

### Structured outputs with TOON payloads

```ruby
class TaskDecomposition < DSPy::Signature
  input  { const :goal, String }
  output { const :tasks, T::Array[T::Hash[String, String]] }
end

predictor = DSPy::Predict.new(TaskDecomposition)
result = predictor.call(goal: "Draft a DSPy smoke test plan")
```

`DSPy::Prompt` now renders the signature guidance + user inputs in TOON blocks and expects TOON replies, so the JSON keys stop repeating and the LM stays anchored to the schema.

### ReAct loop with TOON history + tools

```ruby
class ToonReActSignature < DSPy::Signature
  input  { const :question, String }
  output { const :answer, String }
end

class CityFact < T::Struct
  const :city, String
  const :population, Integer
end

class ToonLookupTool < DSPy::Tools::Base
  tool_name 'lookup_city'
  tool_description 'Return structured population data for a given city'

  sig { params(city: String).returns(CityFact) }
  def call(city:)
    CityFact.new(city: city, population: 2_148_000)
  end
end

agent = DSPy::ReAct.new(ToonReActSignature, tools: [ToonLookupTool.new], max_iterations: 2)
agent.forward(question: "What is the population of Paris?")
```

Each iteration serializes the history, available tools, and observations as TOON tables (see `spec/integration/toon_react_spec.rb` for the full flow), so tool arguments/results round-trip through Sorbet structs without DTO glue.

## Useful links

- Launch article: `docs/src/_articles/toon-data-format.md`
- Sorbet::Toon README + roadmap: `lib/sorbet/toon/README.md`
- Benchmark artifacts: see the latest `schema_data_benchmark_*.{json,csv,txt}` files in `examples/`
- GitHub compare: https://github.com/vicentereig/dspy.rb/compare/v0.30.1...v0.31.0
